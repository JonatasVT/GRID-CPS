-- Copyright 2025 JÃ´natas Venancio Teixeira
-- License: Apache-2.0

function sysCall_init()
    sim = require('sim')
    B4=sim.getObject('..')
    sim.setInt32Signal("B4",B4)
    sim.setStepping(true)
    corout=coroutine.create(coroutineMain)
end

function sysCall_actuation()
    if coroutine.status(corout)~='dead' then
        local ok,errorMsg=coroutine.resume(corout)
        if errorMsg then
            error(debug.traceback(corout,errorMsg),2)
        end
    end
end

function coroutineMain()
    while true do
        --print("coroutineMain, B4")
        if sim.getInt32Signal("NQBdetect")~=nil then
        Pallet=sim.getInt32Signal("NQBdetect")
            p=sim.getObjectPosition(Pallet,B4)
            if (math.abs(p[1])+math.abs(p[2])+math.abs(p[3]))<0.015 then
                if sim.getInt32Signal("B4")==1 then
                    sim.setObjectParent(Pallet,B4,true)
                    sim.setInt32Signal("B4",0)
                    print("B4=0")
                    print(sim.getInt32Signal("NQdetect"))
                    print(sim.getInt32Signal("NQBdetect"))
                end
            end
        end
        if sim.getInt32Signal("CGP")~=nil then
            GP=sim.getInt32Signal("CGP")
            --print("GP="..GP)
            p=sim.getObjectPosition(GP,Pallet)
            if (math.abs(p[1])+math.abs(p[2])+math.abs(p[3]))<0.065 then
                sim.setObjectParent(GP,Pallet,true)
                sim.setObjectPosition(GP,{0,-0.035,0.06},Pallet)
                sim.setInt32Signal("B4",0)
            end
        end
        sim.step()
    end
    
end

function sysCall_cleanup()
   
end
