-- Copyright 2025 JÃ´natas Venancio Teixeira
-- License: Apache-2.0

function sysCall_init()
    sim = require('sim')
    sim.setStepping(true)
    pc={}
    pc[1]=sim.getObject("..")
    sim.setInt32Signal("QMesa",pc[1])
    count=0
    part1=0
    corout=coroutine.create(coroutineMain)
end

function sysCall_actuation()
    if coroutine.status(corout)~='dead' then
        local ok,errorMsg=coroutine.resume(corout)
        if errorMsg then
            error(debug.traceback(corout,errorMsg),2)
        end
    end
end

function coroutineMain()
    C=2
    
    while true do
            print("coroutineMain, NA/Mesa")
            sim.waitForSignal("NQBM")
            pc[C]=sim.getInt32Signal("NQBM")
            print("coroutineMain, NA/Mesa")
            if sim.isHandle (pc[C-1]) then
                if sim.getObjectChild(pc[C-1],C-1)==-1 then
                --print("pc[C-1]")
                --print(sim.getObjectAlias(pc[C-1]))
                --print("pc[C]")
                --print(sim.getObjectAlias(pc[C]))
                    p=sim.checkDistance(pc[C],pc[C-1],0.01)
                    if p==1 then
                        sim.setObjectParent(pc[C],pc[C-1],true)
                        print("Table + square")
                        sim.setInt32Signal("NQcheck",1)
                        sim.clearInt32Signal("NQBM")
                        
                        sim.step()
                    end
                end
            end
            sim.step()
    end
end
function sysCall_cleanup()
end
