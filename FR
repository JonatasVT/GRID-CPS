-- Copyright 2025 JÃ´natas Venancio Teixeira
-- License: Apache-2.0

function sysCall_init()
    sim = require('sim')
    sim.setStepping(true)    
    corout=coroutine.create(coroutineMain)
    connector=sim.getObject('/attachPointF1')
    sim.setInt32Signal("F1",connector)
end

function sysCall_actuation()
    if coroutine.status(corout)~='dead' then
        local ok,errorMsg=coroutine.resume(corout)
        if errorMsg then
            error(debug.traceback(corout,errorMsg),2)
        end
    end
end

function coroutineMain()
    F1S=sim.getObject("../F1S")
    Rack=sim.getInt32Signal("Rack")
    while true do
        sim.waitForSignal("FRC")
        if sim.getInt32Signal("FRC")~=nil then
            obj=sim.getInt32Signal("FRC")
            sig=sim.getObjectAlias(obj)
            p=sim.getObjectPosition(obj,F1S)
            print(obj)
            if sim.getObjectParent(obj)==connector then
                print("detection solta")
                sim.setObjectParent(obj,-1,true) 
                sim.setInt32Signal(sig,0)
                print("F1 se ne pass")
                sim.clearInt32Signal("FRC")
                print("NWpass="..sim.getInt32Signal("NWpass"))
            end
        end
    sim.clearInt32Signal("FRC")
    sim.step()
    end
end
