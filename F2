-- Copyright 2025 JÃ´natas Venancio Teixeira
-- License: Apache-2.0

function sysCall_init()
    sim = require('sim')
    sensorHandle=sim.getObject("../S2A")
    sensorB=sim.getObject("../S2B")
    corout=coroutine.create(coroutineMain)
    connector=sim.getObject('../attachPointF2')
    T=sim.getObject("../T")
    sim.setInt32Signal("F2",connector)
    sim.setStepping(true)
    flag=1
    --
end

function sysCall_actuation()
    if coroutine.status(corout)~='dead' then
        local ok,errorMsg=coroutine.resume(corout)
        if errorMsg then
            error(debug.traceback(corout,errorMsg),2)
        end
    end
end

function coroutineMain()
    F2S=sim.getObject("../F2S")
    sim.waitForSignal("NMR")
    R=sim.getInt32Signal("NMR")
    while true do
        if sim.getInt32Signal("NMwork")~=1 then
            --print("coroutineMain, F2")
            rb,distb,ptb,objb=sim.readProximitySensor(sensorB)
            if (rb==1) then
                r,dist,pt,obj=sim.handleProximitySensor(sensorHandle)
                --print(r)
                if (r==1)then
                    --print("nmp ")
                    --print(sim.getInt32Signal("NMpass"))
                    if sim.getInt32Signal("NMpass")~=1 then
                        --print("Pobj "..sim.getObjectParent(obj))
                        --print("obj "..obj)
                        --print(sim.getObjectAlias(obj))
                        --print("conn "..connector)
                        sig=sim.getObjectAlias(obj)
                        if sim.getObjectParent(obj)~=connector then
                            --print(flag)
                            if objb~= sim.getInt32Signal("NMBdetect") then
                                sim.setInt32Signal("NMBdetect",objb)
                                print("NMB "..sim.getInt32Signal("NMBdetect").." ")
                            end
                            
                            if sim.getObjectAlias(T)~=flag then
                                print("sig "..sig)
                                p=sim.getObjectPosition(obj,F2S)
                                print(math.abs(p[2]))
                                if math.abs(p[2])<0.005 then
                                    sim.setInt32Signal(sig,1)
                                    flag=sim.getObjectAlias(obj)
                                    sim.setObjectParent(obj,connector,true)
                                    sim.wait(2)
                                    sim.setInt32Signal("NMdetect",obj)
                                    sim.step();
                                end
                            end
                        end
                    end
                    if sim.getInt32Signal("NMpass")==1 and sim.getObjectParent(obj)==connector then
                        sim.setInt32Signal(sig,0)
                        sim.setObjectParent(obj,-1,true) 
                        print("F2 se ne pass")
                        sim.wait(1)
                        sim.setInt32Signal("NMpass",0)
                        print("nmp "..sim.getInt32Signal("NMpass"))
                        sim.step();
                    end
                else
                    --sim.setInt32Signal("NMdetect",0)
                    sim.setInt32Signal("NMpass",0)
                end
            end
            --print("NMLOAD=")
            --print(sim.getInt32Signal("NMload"))
            if sim.getInt32Signal("NMload")==1 then
                print("NMLOAD")
                p=sim.getObjectPosition(objb,obj)
                if math.abs(p[3])<0.04 then
                    sim.setObjectParent(objb,obj)
                    sim.setObjectPosition(objb,{0,0,0.0123},obj)
                    sim.setInt32Signal("NMpass",1)
                    sim.setInt32Signal("NMsend",objb)
                    print("nmp "..sim.getInt32Signal("NMpass"))
                    sim.clearInt32Signal("NMload")
                    sim.clearInt32Signal("NMBdetect")
                    sim.clearInt32Signal("B2")
                    sim.clearBufferSignal("NMRP")
                end
            end
        end

        sim.step()
    end
end
